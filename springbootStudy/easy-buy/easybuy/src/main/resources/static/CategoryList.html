<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="css/style.css"/>
    <!--[if IE 6]>
    <script src="js/iepng.js" type="text/javascript"></script>
    <script type="text/javascript">
        EvPNG.fix('div, ul, img, li, input, a');
    </script>
    <![endif]-->

    <!--先导min再导入interceptor-->
    <script src="vue/axios.min.js"></script>
    <script src="vue/axios.interceptor.js"></script>
    <script src="vue/vue.min.js"></script>
    <script src="vue/img.js"></script>
    <title>尤洪</title>


</head>
<body>
<!--Begin Header Begin-->

<div id="soubg">
    <div class="soubg">
        <div class="sou">
            <!--Begin 所在收货地区 Begin-->
            <span class="s_city_b">
        	<span class="fl">送货至：</span>
            <span class="s_city">
            	<span>四川</span>
                <div class="s_city_bg">
                	<div class="s_city_t"></div>
                    <div class="s_city_c">
                    	<h2>请选择所在的收货地区</h2>
                        <table border="0" class="c_tab" style="width:235px; margin-top:10px;" cellspacing="0"
                               cellpadding="0">
                          <tr>
                            <th>A</th>
                            <td class="c_h"><span>安徽</span><span>澳门</span></td>
                          </tr>
                          <tr>
                            <th>B</th>
                            <td class="c_h"><span>北京</span></td>
                          </tr>
                          <tr>
                            <th>C</th>
                            <td class="c_h"><span>重庆</span></td>
                          </tr>
                          <tr>
                            <th>F</th>
                            <td class="c_h"><span>福建</span></td>
                          </tr>
                          <tr>
                            <th>G</th>
                            <td class="c_h"><span>广东</span><span>广西</span><span>贵州</span><span>甘肃</span></td>
                          </tr>
                          <tr>
                            <th>H</th>
                            <td class="c_h"><span>河北</span><span>河南</span><span>黑龙江</span><span>海南</span><span>湖北</span><span>湖南</span></td>
                          </tr>
                          <tr>
                            <th>J</th>
                            <td class="c_h"><span>江苏</span><span>吉林</span><span>江西</span></td>
                          </tr>
                          <tr>
                            <th>L</th>
                            <td class="c_h"><span>辽宁</span></td>
                          </tr>
                          <tr>
                            <th>N</th>
                            <td class="c_h"><span>内蒙古</span><span>宁夏</span></td>
                          </tr>
                          <tr>
                            <th>Q</th>
                            <td class="c_h"><span>青海</span></td>
                          </tr>
                          <tr>
                            <th>S</th>
                            <td class="c_h"><span>上海</span><span>山东</span><span>山西</span><span
                                    class="c_check">四川</span><span>陕西</span></td>
                          </tr>
                          <tr>
                            <th>T</th>
                            <td class="c_h"><span>台湾</span><span>天津</span></td>
                          </tr>
                          <tr>
                            <th>X</th>
                            <td class="c_h"><span>西藏</span><span>香港</span><span>新疆</span></td>
                          </tr>
                          <tr>
                            <th>Y</th>
                            <td class="c_h"><span>云南</span></td>
                          </tr>
                          <tr>
                            <th>Z</th>
                            <td class="c_h"><span>浙江</span></td>
                          </tr>
                        </table>
                    </div>
                </div>
            </span>
        </span>
            <!--End 所在收货地区 End-->
            <span class="fr">
        	<span class="fl">你好，请<a href="Login.html">登录</a>&nbsp; <a href="Regist.html" style="color:#ff4e00;">免费注册</a>&nbsp;|&nbsp;<a
                    href="#">我的订单</a>&nbsp;|</span>
        	<span class="ss">
            	<div class="ss_list">
                	<a href="#">收藏夹</a>
                    <div class="ss_list_bg">
                    	<div class="s_city_t"></div>
                        <div class="ss_list_c">
                        	<ul>
                            	<li><a href="#">我的收藏夹</a></li>
                                <li><a href="#">我的收藏夹</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="ss_list">
                	<a href="#">客户服务</a>
                    <div class="ss_list_bg">
                    	<div class="s_city_t"></div>
                        <div class="ss_list_c">
                        	<ul>
                            	<li><a href="#">客户服务</a></li>
                                <li><a href="#">客户服务</a></li>
                                <li><a href="#">客户服务</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="ss_list">
                	<a href="#">网站导航</a>
                    <div class="ss_list_bg">
                    	<div class="s_city_t"></div>
                        <div class="ss_list_c">
                        	<ul>
                            	<li><a href="#">网站导航</a></li>
                                <li><a href="#">网站导航</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </span>
            <span class="fl">|&nbsp;关注我们：</span>
            <span class="s_sh"><a href="#" class="sh1">新浪</a><a href="#" class="sh2">微信</a></span>
            <span class="fr">|&nbsp;<a href="#">手机版&nbsp;<img src="images/s_tel.png" align="absmiddle"/></a></span>
        </span>
        </div>
    </div>
    <div class="top">
        <div class="logo"><a href="Index.html"><img src="images/logo.png"/></a></div>

        <div class="search">
            <form>
                <input type="text" v-model="name" class="s_ipt"/>
                <input type="button" value="搜索" class="s_btn" @click="nameSelect"/>
            </form>
            <span class="fl"><a href="#">咖啡</a><a href="#">iphone 6S</a><a href="#">新鲜美食</a><a href="#">蛋糕</a><a
                    href="#">日用品</a><a href="#">连衣裙</a></span>
        </div>

        <div class="i_car">
            <div class="car_t">购物车 [ <span>{{car.totalNum}}</span> ]</div>

            <div class="car_bg">

                <!--Begin 购物车未登录 Begin-->
                <div class="un_login" v-if="loginName==''">还未登录！<a href="/api/Login.html" style="color:#ff4e00;">马上登录</a>
                    查看购物车！
                </div>


                <!--End 购物车未登录 End-->
                <!--Begin 购物车已登录 Begin-->
                <div v-else>
                    <ul class="cars">
                        <li v-for="carDetail in carDetailList">
                            <div class="img"><a href="#"><img
                                    :src="imgURL+carDetail.fileName" width="58"
                                    height="58"/></a></div>
                            <div class="name"><a href="#">{{carDetail.productName}}</a></div>
                            <div class="price"><font color="#ff4e00">{{carDetail.price}}</font> X{{carDetail.buyNum}}
                            </div>
                        </li>
                    </ul>
                    <div class="price_sum">共计&nbsp; <font color="#ff4e00">￥</font><span>{{car.totalPrice}}</span>
                    </div>
                    <div class="price_a"><a :href="'BuyCar.html?id='+car.id">去购物车结算</a></div>
                    <!--End 购物车已登录 End-->
                </div>
            </div>
        </div>
    </div>
    <!--End Header End-->
    <!--Begin Menu Begin-->
    <div class="menu_bg">
        <div class="menu">

            <!--Begin 商品分类详情 Begin-->
            <div class="nav">
                <div class="nav_t" @click="showAllProduct"><a style="color: white" href="#">全部商品分类</a></div>
            </div>


            <!--End 商品分类详情 End-->
            <ul class="menu_r">
                <li><a href="Index.html">首页</a></li>
                <li v-for="type in pcList" v-if="type.type==1">
                    <a href="#" @click.prevent="typeSelect(type.id)">{{type.name}}</a>
                </li>
            </ul>
            <div class="m_ad">中秋送好礼！</div>
        </div>
    </div>
    <!--End Menu End-->
    <!--End 筛选条件 End-->

    <div class="content mar_20">
        <div class="l_history">
            <div class="his_t">
                <span class="fl">商品收藏</span>
                <span class="fr"><a href="#" @click="delAllCollects">清空</a></span>
            </div>
            <ul v-for="collect in collectList" @click="findProductDetail(collect.productId)">
                <li>
                    <div class="img"><a href="#"><img
                            :src="imgURL+collect.fileName" width="185"
                            height="162"/></a></div>
                    <div class="name"><a href="#">{{collect.productName}}</a></div>
                    <div class="price">
                        <font>￥<span>{{collect.productPrice}}</span></font>
                    </div>
                </li>
            </ul>
        </div>


        <div class="l_list">
            <div class="list_t">
                <span class="fr" style="float: left"><h2>共发现{{pageInfo.total}}件</h2></span>
            </div>

            <div class="list_c">

                <ul class="cate_list">
                    <li v-for="product in pageInfo.list">

                        <div class="img" @click.prevent="findProductDetail(product.id)"><a href="#"><img
                                :src="imgURL+product.fileName" width="210"
                                height="185"/></a>
                        </div>

                        <div class="price">
                            <font>￥<span>{{product.price}}</span></font> &nbsp; 元
                        </div>

                        <div class="name"><span v-html="product.name"></span></div>

                        <div class="carbg">
                            <a href="#" class="ss" @click.prevent="addCollect(product.id)">收藏</a>
                            <a href="#" class="j_car" @click.prevent="addCar(product.id)">加入购物车</a>
                        </div>
                    </li>
                </ul>


                <!--上下页切换-->
                <p style="margin-top:90px;text-align: center" v-if="pageInfo.pages!=0">
                    <span>共{{pageInfo.pageNum}}/{{pageInfo.pages}}页</span>

                    <button v-if="pageInfo.pageNum>1" @click.prevent="nextPage('home')">首页</button>
                    <button v-if="pageInfo.pageNum>1" @click.prevent="nextPage('pre')">上页</button>

                    <span v-for="toPage in pageInfo.pages">

                        <button v-if="toPage===pageInfo.pageNum" @click.prevent="selectProduct(toPage, 12)"
                                class="selectButton">
                            {{toPage}}&nbsp;
                        </button>


                        <button v-else @click.prevent="selectProduct(toPage, 12)" class="unSelectButton">
                            {{toPage}}&nbsp;
                        </button>

                </span>

                    <button v-if="pageInfo.pageNum<pageInfo.pages" @click.prevent="nextPage('next')">下页</button>
                    <button v-if="pageInfo.pageNum<pageInfo.pages" @click.prevent="nextPage('end')">末页</button>
                </p>

                <div v-if="pageInfo.pages==0">
                    <h2 style="text-align: center">暂无数据</h2>
                </div>


            </div>
        </div>
    </div>

    <!--Begin Footer Begin -->
    <div class="b_btm_bg bg_color">
        <div class="b_btm">
            <table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
                   cellspacing="0" cellpadding="0">
                <tr>
                    <td width="72"><img src="images/b1.png" width="62" height="62"/></td>
                    <td><h2>正品保障</h2>正品行货 放心购买</td>
                </tr>
            </table>
            <table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
                   cellspacing="0" cellpadding="0">
                <tr>
                    <td width="72"><img src="images/b2.png" width="62" height="62"/></td>
                    <td><h2>满38包邮</h2>满38包邮 免运费</td>
                </tr>
            </table>
            <table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
                   cellspacing="0" cellpadding="0">
                <tr>
                    <td width="72"><img src="images/b3.png" width="62" height="62"/></td>
                    <td><h2>天天低价</h2>天天低价 畅选无忧</td>
                </tr>
            </table>
            <table border="0" style="width:210px; height:62px; float:left; margin-left:75px; margin-top:30px;"
                   cellspacing="0" cellpadding="0">
                <tr>
                    <td width="72"><img src="images/b4.png" width="62" height="62"/></td>
                    <td><h2>准时送达</h2>收货时间由你做主</td>
                </tr>
            </table>
        </div>
    </div>
    <div class="b_nav">
        <dl>
            <dt><a href="#">新手上路</a></dt>
            <dd><a href="#">售后流程</a></dd>
            <dd><a href="#">购物流程</a></dd>
            <dd><a href="#">订购方式</a></dd>
            <dd><a href="#">隐私声明</a></dd>
            <dd><a href="#">推荐分享说明</a></dd>
        </dl>
        <dl>
            <dt><a href="#">配送与支付</a></dt>
            <dd><a href="#">货到付款区域</a></dd>
            <dd><a href="#">配送支付查询</a></dd>
            <dd><a href="#">支付方式说明</a></dd>
        </dl>
        <dl>
            <dt><a href="#">会员中心</a></dt>
            <dd><a href="#">资金管理</a></dd>
            <dd><a href="#">我的收藏</a></dd>
            <dd><a href="#">我的订单</a></dd>
        </dl>
        <dl>
            <dt><a href="#">服务保证</a></dt>
            <dd><a href="#">退换货原则</a></dd>
            <dd><a href="#">售后服务保证</a></dd>
            <dd><a href="#">产品质量保证</a></dd>
        </dl>
        <dl>
            <dt><a href="#">联系我们</a></dt>
            <dd><a href="#">网站故障报告</a></dd>
            <dd><a href="#">购物咨询</a></dd>
            <dd><a href="#">投诉与建议</a></dd>
        </dl>
        <div class="b_tel_bg">
            <a href="#" class="b_sh1">新浪微博</a>
            <a href="#" class="b_sh2">腾讯微博</a>
            <p>
                服务热线：<br/>
                <span>400-123-4567</span>
            </p>
        </div>
        <div class="b_er">
            <div class="b_er_c"><img src="images/er.gif" width="118" height="118"/></div>
            <img src="images/ss.png"/>
        </div>
    </div>
    <div class="btmbg">
        <div class="btm">
            备案/许可证编号：蜀ICP备12009302号-1-www.dingguagua.com Copyright © 2015-2018 尤洪商城网 All Rights Reserved.
            复制必究 , Technical Support: Dgg Group <br/>
            <img src="images/b_1.gif" width="98" height="33"/><img src="images/b_2.gif" width="98" height="33"/><img
                src="images/b_3.gif" width="98" height="33"/><img src="images/b_4.gif" width="98" height="33"/><img
                src="images/b_5.gif" width="98" height="33"/><img src="images/b_6.gif" width="98" height="33"/>
        </div>
    </div>
    <!--End Footer End -->
</div>

</div>

</body>

<script>
    let urlParams = new URLSearchParams(window.location.search);
    let name = urlParams.get('name');
    let categoryId = urlParams.get('categoryId');


    let vm = new Vue({
        el: "#soubg",

        data: {
            pcList: "",
            name: name,
            categoryId: categoryId,
            pageInfo: "",


            loginName: "",
            car: "",
            carDetailList: "",

            collectList: "",
        },

        methods: {


            //删除所有收藏
            delAllCollects() {
                let result = confirm("您确定要删除所有收藏吗?");

                if (result == false) {
                    return;
                }

                axios({
                    url: "/api/collect/delAllCollects",
                    params: {
                        loginName: this.loginName,
                    }
                }).then(rs => {
                    if (rs.data.isDel == true) {
                        alert("删除成功");
                        this.getCollectList();
                    }
                })
            },

            //显示收藏
            getCollectList() {
                axios({
                    url: "/api/collect/getCollectsList",
                    params: {
                        loginName: this.loginName,
                    }
                }).then(rs => {
                    this.collectList = rs.data.collectList;
                    console.log(rs.data.collectList);
                })
            },

            //添加收藏
            addCollect(id) {
                axios({
                    url: "/api/collect/addCollect",
                    params: {
                        id,
                        loginName: this.loginName,
                    }
                }).then(rs => {
                    console.log(rs.data.isAdd);

                    if (rs.data.isAdd == true) {
                        alert("添加成功");
                        this.getCollectList();
                    }

                    if(rs.data.isAdd==false) {
                        alert("已经收藏过商品了");
                        this.getCollectList();
                    }
                })
            },


            //购物车展示购买的商品
            getCar() {
                axios({
                    url: "/api/car/getCar",
                    params: {
                        loginName: this.loginName,
                    },
                }).then(rs => {
                    this.car = rs.data.car;
                    console.log("=======================", this.car);

                    //定义一个专门存放 购物车的数组 把返回的集合遍历,集合元素放入数组
                    let array = [];

                    for (let car in rs.data.carMap) {
                        array.push(rs.data.carMap[car]);
                    }

                    this.carDetailList = array;
                })
            },


            //添加购物车,获取商品id
            addCar(id) {
                axios({
                    url: "/api/product/selectProduct",
                    params: {
                        id
                    }
                }).then(rs => {

                    //遍历购物车详情购买的数量
                    let carStock = 0;
                    for (let carDetail in this.carDetailList) {
                        if (id == this.carDetailList[carDetail].productId) {
                            carStock = this.carDetailList[carDetail].buyNum;
                        }
                    }

                    //如果商品的数量小于购物车的数量
                    let stock = rs.data.product.stock;
                    if (stock <= carStock) {
                        alert("库存不足");
                        return;
                    }

                    //添加购物车
                    axios({
                        url: "/api/car/addCar",
                        params: {
                            loginName: this.loginName,
                            productId: rs.data.product.id,
                            productName: rs.data.product.name,
                            fileName: rs.data.product.fileName,
                            price: rs.data.product.price,
                            buyNum: 1,
                            stock: rs.data.product.stock,
                        },
                    }).then(rs => {
                        alert("添加成功");
                        this.getCar();
                    })
                })
            },

            //查询商品详情
            findProductDetail(id) {
                window.location = '/api/Product.html?id=' + id;
            },


            //展示所有商品
            showAllProduct() {
                this.name = "";
                this.categoryId = "";
                this.selectProduct(1, 12);
            },


            //上下页切换
            nextPage: function (opr) {
                let pageNum = 1;

                switch (opr) {

                    case 'pre':
                        pageNum = this.pageInfo.pageNum - 1 == 0 ? 1 : this.pageInfo.pageNum - 1;
                        break;

                    case 'next':
                        pageNum = this.pageInfo.pageNum + 1 > this.pageInfo.pages ? this.pageInfo.pages : this.pageInfo.pageNum + 1;
                        break;

                    case 'end':
                        pageNum = this.pageInfo.pages;
                        break;
                }

                // 这里把数据放到vm里面要用this
                this.selectProduct(pageNum, 12);
            },


            //查询商品的方法
            selectProduct(pageNum, pageSize) {
                axios({
                    url: "/api/product/findProductByEs",
                    params: {
                        pageNum,
                        pageSize,
                        name: this.name,
                        categoryId: this.categoryId,
                    },
                }).then(rs => {
                    this.pageInfo = rs.data.pageInfo;
                })
            },


            nameSelect() {
                this.selectProduct(1, 12);
            },


            //根据分类查询
            typeSelect(id) {
                this.categoryId = id;
                this.selectProduct(1, 12);
            },


            //一个页面出来就加载的方法
            doInit() {
                this.selectProduct(1, 12);
                axios({
                    url: "/api/pc/showPCList"
                }).then(rs => {
                    this.pcList = rs.data.pcList;
                })
            },
        },

        created: function () {

            //没有登录也可以看商品列表
            this.doInit();

            let token = window.sessionStorage.getItem("token")
            if (token == null || token == "") {
                this.doInit();
            } else {
                axios({
                    url: "/api/user/findUserFromToken",
                }).then(rs => {
                    this.loginName = rs.data.user.loginName;
                    this.getCar();
                    this.getCollectList();
                })
            }
        }

    })


</script>


</html>
